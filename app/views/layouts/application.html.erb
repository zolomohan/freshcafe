<!DOCTYPE html>
<html>
  <head>
    <title>Freshcafe</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!-- Semantic UI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" integrity="sha512-8bHTC73gkZ7rZ7vpqUQThUDhqcNFyYi2xgDgPDHc+GXVGHXq+xPjynxIopALmOPqzo9JZj0k6OqqewdGO3EsrQ==" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.js" integrity="sha512-dqw6X88iGgZlTsONxZK9ePmJEFrmHwpuMrsUChjAw1mRUhUITE5QU9pkcSox+ynfLhL15Sv2al5A0LVyDCmtUw==" crossorigin="anonymous"></script>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    
    <script src="https://kit.fontawesome.com/770ca4bfb4.js" crossorigin="anonymous"></script>

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
  </head>

  <body>
    <%= render 'layouts/navbar' %>

    
    <div class="px-5">
      <% if notice %>
      <div class="ui message transition mt-4">
        <p><%= notice %></p>
      </div>
      <% end %>

      <%= yield %>

      <div class="panel">
        <div class="header">
          <p class="lead">My Cart (<%=current_user.cart_count%>)</p>
          <i id="toggle-panel" class="fas fa-chevron-up"></i>
        </div>
        <div id="items" class="mt-3 d-none">
          <% get_cart_items.each do |cart_item| %>
          <div class="item">
            <div class="left">
              <div class="name"><%= cart_item[:item].name%></div>
              <div class="quantity text-muted">Quantity: <%= cart_item[:quantity]%></div>
              <div id="item-actions" class="mt-2 ui circular labels">
                <%=link_to increase_quantity_cart_path(cart_item[:item]), method: :put, class: "me-2 ui label", style: "text-decoration: none" do %>
                  <i class="fas fa-plus"></i>
                <% end %>
                <%=link_to decrease_quantity_cart_path(cart_item[:item]), method: :put, class: "me-2 ui label", style: "text-decoration: none" do %>
                  <i class="fas fa-minus"></i>
                <% end %>
                <%=link_to remove_from_cart_path(cart_item[:item]), method: :put, class: "button ui negative label", style: "text-decoration: none" do %>
                  <i class="fas fa-times"></i>
                <% end %>
              </div>
            </div>
            <div class="price text-muted">
              ₹ <%= cart_item[:item].price%>
            </div>
           
          </div>
          <hr>
          <% end %>
        </div>
        <div id="panel-footer" class="footer d-none">
          <p class="lead mb-3 pt-3">Total Price: ₹ <%= get_cart_items.reduce(0)  {|sum, cart_item| sum + (cart_item[:item].price * cart_item[:quantity].to_i) } %></p>
        </div>
        <% order_create_params = [] %>
        <% get_cart_items.each do |cart_item| %>
          <% order_create_params.push({:id => cart_item[:item].id, :name => cart_item[:item].name, :price => cart_item[:item].price, :quantity => cart_item[:quantity]}) %>
        <% end %>
        <%= button_to "Proceed to Checkout", order_path, params: {items: order_create_params.to_json}, class: "ui secondary button d-none", id: "checkout-button", style: "width: 100%"%>
      </div>
    </div>
  </body>
  <script>
    $('#toggle-panel').click(() => {
      let is_panel_minimized = $(".panel").css('height') === "70px";
      if(!is_panel_minimized) {
        $(".panel").css('height', '70px')
        $("#items").addClass('d-none')
        $("#panel-footer").addClass('d-none')
        $("#checkout-button").addClass('d-none')
        $('#toggle-panel').addClass('fa-chevron-up')
        $('#toggle-panel').removeClass('fa-chevron-down')

      } else {
        $(".panel").css('height', '700px')
        $("#items").removeClass('d-none')
        $("#panel-footer").removeClass('d-none')
        $("#checkout-button").removeClass('d-none')
        $('#toggle-panel').removeClass('fa-chevron-up')
        $('#toggle-panel').addClass('fa-chevron-down')
      }
    })
  </script>
</html>
